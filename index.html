<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coinbase</title>
    <style>
      .container {
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Real time data from Coinbase over websocket API</h1>
      <div>
        <h2>Time</h2>
        <p class="time"></p>
      </div>
      <div>
        <h2>Sell</h2>
        <p class="sell"></p>
      </div>
      <div>
        <h2>Buy</h2>
        <p class="buy"></p>
      </div>
    </div>
  </body>
</html>
<script>
  const url = "wss://ws-feed.pro.coinbase.com";

  const socket = new WebSocket(url);

  socket.onopen = () => {
    socket.send(
      JSON.stringify({
        type: "subscribe",
        channels: ["full"],
        product_ids: ["BTC-USD"],
      })
    );
  };

  const avgPrice = (item) => {
    const Average =
      item.reduce((previousValue, currentValue) => {
        return previousValue + Number(currentValue.price);
      }, 0) / item.length;

    return Average.toFixed(2);
  };

  const sellData = [];
  const buyData = [];

  const timer = setInterval(() => {
    appendData(buyData, "buy");
    appendData(sellData, "sell");
  }, 5000);

  const appendData = (info, type) => {
    if (info) {
      const average = avgPrice(info);
      const timeDiv = document.querySelector(`.time`);
      const priceDiv = document.querySelector(`.${type}`);

      timeDiv.innerHTML = `Time ${new Date().toLocaleTimeString()}`;
      priceDiv.innerHTML = `Average requested ${type} price: ${average}`;
    }
  };

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    for (let x in data) {
      const side = data.side;
      const type = data.type;

      // Sell data
      if (type == "received" && side == "sell") {
        if (sellData.length > 100) {
          buyData.shift();
        }
        sellData.push(data);
      }

      // Buy data
      if (type == "received" && side == "buy") {
        if (buyData.length > 100) {
          buyData.shift();
        }
        buyData.push(data);
      }
    }
  };
</script>
